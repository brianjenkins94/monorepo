{
	"name": "ci",
	"on": {
		"push": {
			"branches": [
				"main"
			]
		}
	},
	"jobs": {
		"build": {
			"runs-on": "ubuntu-latest",
			"steps": [
				{
					"uses": "actions/checkout@v3"
				},
				{
					"uses": "actions/setup-node@v3",
					"with": {
						"node-version": 18
					}
				},
				{
					"run": "npm install"
				},
				{
					"run": "npm run build"
				}
			]
		},
		"lint": {
			"runs-on": "ubuntu-latest",
			"steps": [
				{
					"uses": "actions/checkout@v3"
				},
				{
					"uses": "actions/setup-node@v3",
					"with": {
						"node-version": 18
					}
				},
				{
					"run": "npm install"
				},
				{
					"run": "npm run lint"
				}
			]
		},
		"test": {
			"runs-on": "ubuntu-latest",
			"steps": [
				{
					"uses": "actions/checkout@v3"
				},
				{
					"uses": "actions/setup-node@v3",
					"with": {
						"node-version": 18
					}
				},
				{
					"run": "npm install"
				},
				{
					"run": "npm run test"
				}
			]
		},
		"enumerate": {
			"runs-on": "ubuntu-latest",
			"needs": ["lint", "build", "test"],
			"steps": [
				{
					"uses": "actions/checkout@v3",
					"with": {
						"fetch-depth": 2
					}
				},
				{
					"name": "For each `package.json` that has changed since the previous commit...",
					"run": "echo PACKAGES=[$(find . -mindepth 2 -name \"package.json\" -not -path \"*/.*\" -not -path \"*/node_modules/**\" -exec git diff HEAD^ --quiet \"{}\" \\; -exec echo \"{}\" \\; | sed -z \"s/^/\\\"/;s/\\n$/\\\"/;s/\\n/\\\",\\\"/g\")] >> $GITHUB_OUTPUT"
				},
				{
					"name": "That is not private...",
					"run": "$GITHUB_OUTPUT"
				}
			]
		},
		"release": {
			"runs-on": "ubuntu-latest",
			"needs": ["enumerate"],
			"strategy": {
				"matrix": {
					"packages": "${{ needs.*.outputs.PACKAGES }}"
				}
			},
			"steps": [
				{
					"uses": "softprops/action-gh-release@v1",
					"env": {
						"GITHUB_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
					},
					"with": {
						"name": "Release v${{ needs.check_if_version_upgraded.outputs.to_version }}",
						"tag_name": "v${{ needs.check_if_version_upgraded.outputs.to_version }}",
						"target_commitish": "${{ github.head_ref || github.ref }}"
					}
				}
			]
		},
		"publish": {
			"runs-on": "ubuntu-latest",
			"needs": ["release"],
			"strategy": {
				"matrix": {
					"packages": "${{ needs.*.outputs.PACKAGES }}"
				}
			},
			"steps": [
				{
					"uses": "actions/checkout@v3"
				},
				{
					"uses": "actions/setup-node@v3",
					"with": {
						"node-version": 18
					}
				},
				{
					"run": "npm install"
				},
				{
					"run": "npm build"
				},
				{
					"run": "npm publish",
					"env": {
						"NODE_AUTH_TOKEN": "${{ secrets.NPM_TOKEN }}",
						"VERSION": "${{ needs.check_if_version_upgraded.outputs.to_version }}"
					}
				}
			]
		}
	}
}
